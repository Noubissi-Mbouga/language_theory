name: Build Embedded EXE

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install PyQt6==6.6.0
        pip install graphviz==0.20.1
        pip install pyinstaller==6.2.0
        
    - name: Create directory structure
      shell: cmd  # <-- IMPORTANT: utiliser CMD au lieu de PowerShell
      run: |
        echo Création de la structure de dossiers...
        
        if not exist src mkdir src
        if not exist data mkdir data
        if not exist graphviz mkdir graphviz
        
        echo Vérification des fichiers sources...
        dir *.py || echo Aucun fichier .py dans le répertoire courant
        
    - name: Copy Python files to src
      shell: cmd  # <-- IMPORTANT: utiliser CMD
      run: |
        echo Copie des fichiers Python...
        
        if exist *.py (
          copy *.py src\
          echo Fichiers copiés dans src/
        ) else (
          echo Aucun fichier .py à copier
        )
        
        echo Contenu de src/:
        dir src\ || echo Le dossier src/ est vide
        
    - name: Download Graphviz portable
      shell: cmd  # <-- IMPORTANT: utiliser CMD
      run: |
        echo Téléchargement de Graphviz portable...
        
        if not exist graphviz\bin\dot.exe (
          echo Téléchargement depuis GitHub...
          curl -L -o graphviz.zip https://github.com/mcxiaoke/graphviz-portable/releases/download/v2.50.0/GraphvizPortable_2.50.0.zip
          
          echo Extraction...
          if exist graphviz.zip (
            powershell -Command "Expand-Archive -Path graphviz.zip -DestinationPath . -Force"
            del graphviz.zip
            
            echo Réorganisation des fichiers...
            if exist GraphvizPortable (
              xcopy GraphvizPortable\* graphviz\ /E /I /Y
              rd GraphvizPortable /S /Q
            )
          )
        ) else (
          echo Graphviz est déjà présent
        )
        
    - name: Build with PyInstaller
      shell: cmd  # <-- IMPORTANT: utiliser CMD
      run: |
        echo Construction avec PyInstaller...
        
        pyinstaller --onefile --windowed ^
          --name=GrammaireChecker ^
          --hidden-import=graphviz ^
          --hidden-import=graphviz.backend ^
          --hidden-import=graphviz.backend.execute ^
          --add-data="graphviz;graphviz" ^
          --add-data="src;src" ^
          --clean ^
          src/interface.py
        
        echo Vérification du résultat...
        if exist dist\GrammaireChecker.exe (
          echo SUCCÈS: dist\GrammaireChecker.exe créé
          dir dist\GrammaireChecker.exe
        ) else (
          echo ÉCHEC: Fichier non créé
          exit 1
        )
        
    - name: Create launcher script
      shell: cmd
      run: |
        echo Création du script de lancement...
        
        echo @echo off > dist\Lancer.bat
        echo echo GrammaireChecker - Version Portable >> dist\Lancer.bat
        echo echo. >> dist\Lancer.bat
        echo echo Lancement de l'application... >> dist\Lancer.bat
        echo echo. >> dist\Lancer.bat
        echo start "" "GrammaireChecker.exe" >> dist\Lancer.bat
        echo pause >> dist\Lancer.bat
        
    - name: Upload executable as artifact
      uses: actions/upload-artifact@v4
      with:
        name: GrammaireChecker
        path: |
          dist/GrammaireChecker.exe
          dist/Lancer.bat
